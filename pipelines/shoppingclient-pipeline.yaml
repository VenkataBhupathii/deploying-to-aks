trigger:
  branches:
    include:
      - main
      - feature/*
  paths:
    include:
      - Shopping/Shopping.Client/*
      - aks/shoppingclient.yaml

resources:
  - repo: self

variables:
  imageRepository: 'venkatabhupathi/shopping-client'
  dockerfilePath: 'Shopping/Shopping.Client/Dockerfile'
  tag: '$(Build.BuildId)-$(Build.SourceVersion)'  # Improved tagging strategy
  imagePullSecret: 'dockerhub-secret'
  vmImageName: 'ubuntu-latest'
  namespace: 'default'
  containerImage: '$(imageRepository):$(tag)'

stages:
- stage: Build
  displayName: Build stage
  jobs:
    - job: Build
      displayName: Build
      pool:
        vmImage: $(vmImageName)
      steps:
        - task: Docker@2
          displayName: Build and push an image to Docker Hub
          inputs:
            command: buildAndPush
            repository: $(imageRepository)
            dockerfile: $(dockerfilePath)
            containerRegistry: 'Docker Hub'  # Reference to Docker Hub Service Connection
            buildContext: $(Build.SourcesDirectory)/Shopping
            tags: |
              $(tag)
        - upload: aks
          artifact: aks

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  jobs:
    - deployment: Deploy
      displayName: Deploy Shopping Client
      pool:
        vmImage: $(vmImageName)
      environment: 'aspnetrunrundevops.default'
      strategy:
        runOnce:
          deploy:
            steps:
            - task: KubernetesManifest@0
              displayName: Create imagePullSecret
              inputs:
                action: createSecret
                secretType: dockerRegistry
                secretName: $(imagePullSecret)
                namespace: $(namespace)
                dockerRegistryEndpoint: 'Docker Hub'  # Reference to Docker Hub Service Connection for pulling the image
            - task: KubernetesManifest@0
              displayName: Deploy Shopping Client to Kubernetes cluster
              inputs:
                action: deploy
                manifests: |
                  $(Pipeline.Workspace)/aks/shoppingclient.yaml
                namespace: $(namespace)
                imagePullSecrets: |
                  $(imagePullSecret)
                containers: |
                  $(containerImage)
                kubernetesServiceConnection: 'KubernetesConnection'  # Reference to Kubernetes Service Connection
